<script>
function edit(id, same_week, has_requests) {
  if (!has_requests) {
    alert("This project has no request, you should edit the workpackage")
    }
  if(same_week || confirm('This status is old. You should add a new status.\nAre you sure you want to edit it?')) {
    location = '/projects/edit_status/'+id;
    }
  }
function add(id, same_week, has_requests) {
  if (!has_requests) {
    alert("This project has no request, you should edit the workpackage")
    return;
    }
  if(!same_week || confirm('There is a status for this week already.\nAre you sure you want to add a new status?')) {
    location = '/projects/add_status_form/'+id;
    }
  }
</script>


<div id="submenu">
<%= @project.icon_status %>
<h2><%= @project.full_name %> </h2>
<%= link_to('Edit project', {:action=>'edit', :id=>@project.id}, {:class=>'btnlnk'}) %>
<% if @project.requests.size > 0 %>
  <%= link_to_function('Add/Refresh status for this week', "add(#{@project.id}, #{s = @project.get_status; s.updated_at ? s.updated_at.to_date.cweek == Date.today.cweek : false}, #{@project.has_requests})", {:class=>'btnlnk'}) %>
  <%= link_to('Add action', {:controller=>'actions', :action=>'new', :project_id=>@project.id}, {:class=>'btnlnk'}) %>
  <%= link_to('Add milestone', {:controller=>'milestones', :action=>'new', :project_id=>@project.id}, {:class=>'btnlnk'}) %>
  <%= link_to('Add amendment', {:controller=>'amendments', :action=>'new', :project_id=>@project.id}, {:class=>'btnlnk'}) %>
  <%= link_to('Add note', {:controller=>'notes', :action=>'new', :project_id=>@project.id}, {:class=>'btnlnk'}) %>
<% end %>
<% if @project.responsibles.exists?(current_user) %>
  <%= link_to_remote('Remove from my projects', {:url=>{:controller=>'projects', :action=>'remove_from_mine', :id=>@project.id}, :success=>"$('btnaddtomine').fade();"}, {:class=>'btnlnk special', :id=>'btnaddtomine'}) %>
<% else %>
  <%= link_to_remote('Add to my projects', {:url=>{:controller=>'projects', :action=>'add_to_mine', :id=>@project.id}, :success=>"$('btnaddtomine').fade();"}, {:class=>'btnlnk special', :id=>'btnaddtomine'}) %>
<% end %>
</div>

<div id="subcontent">
<%= link_to_function('Informations', '$("infos").toggle();', :class=>"menu") %><br/>

<div class="panel" id="infos"<% if @project.requests.size > 0 %> style="display:none"<%end%>>
<b>Supervisor</b>: <% if not @project.supervisor_id %>?<% else %><%= @project.supervisor.name %><% end %><br/>
<b>WS</b>: <%= @project.workstream %><br/>
<b>BRN</b>: <%= @project.brn %><br/>
<b>Coordinator</b>: <%= @project.coordinator %><br/>
<b>PM</b>: <%= @project.pm %> (from RMT: <%=@project.request_pm.join(', ')%>)<br/>
<b>BPL</b>: <%= @project.bpl %><br/>
<b>ISPL</b>: <%= @project.ispl %><br/>
<b>SQLI:</b> <%=@project.assignees.join(', ')%>
<% if @project.description and @project.description!=''%>
  <%= simple_format(@project.description) %>
<% end %>
</div>
<br/>
<% if @project.requests.size > 0 or @project.has_status %>

  <h3>Status</h3>

  <div class="milestone_bar">
  <%= render(:partial=>'milestones/milestone', :collection=>@project.sorted_milestones) %>
  </div>

  <%= display_status(@status) %>
  <br/>

  <%= link_to_function("Old (#{@old_statuses.size})", "$('old_statuses').toggle();", :class=>"menu") %>
  <div id='old_statuses' style="display:none;">
  <% for s in @old_statuses %>
  <ul>
  <%= display_status(s) %>
  <% end %>
  <% for s in @old_statuses %></ul><% end %>
  </div>
<% end %>

<% if @project.requests.size > 0  or @project.actions.size > 0 %>
  <div class="panel">
    <h3>Amendments</h3>
    <%= render(:file=>'amendments/amendments_header') %>
    <%= render(:partial=>'amendments/amendment', :collection=>@project.amendments) %>
    </table>
  </div>

  <div class="panel">
    <h3>Actions</h3>
    <%= render(:file=>'actions/actions_header') %>
    <%= render(:partial=>'actions/action', :collection=>@project.visible_actions(current_user.id)) %>
    </table>
  </div>

  <div class="panel">
    <h3>Notes</h3>
    <%= render(:partial=>'notes/note', :collection=>@project.visible_notes(current_user.id)) %>
  </div>
<% end %>

<div class="panel">
  <h3>Project</h3>
  <% if @project.project %>
    <ul>
    <%= render(:partial=>'project', :object=>@project.project) %>
    </ul>
  <% end %>

  <h3>Requests</h3>
  <ul>
  <%= render(:partial=>'request', :collection=>@project.requests) %>
  </ul>

  <h3>Workpackages</h3>
  <ul>
  <%= render(:partial=>'project', :collection=>@project.projects) %>
  </ul>
  </div>
</div>
